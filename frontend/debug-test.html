<!DOCTYPE html>
<html>
<head>
    <title>Debug Test</title>
</head>
<body>
    <h1>Debug Connection Test</h1>
    <button onclick="runTests()">Run Tests</button>
    <div id="output"></div>

    <script>
        function log(message, isError = false) {
            const output = document.getElementById('output');
            const p = document.createElement('p');
            p.textContent = message;
            if (isError) {
                p.style.color = 'red';
            } else {
                p.style.color = 'green';
            }
            output.appendChild(p);
            console.log(message);
        }

        async function runTests() {
            document.getElementById('output').innerHTML = '';
            
            try {
                log('Starting tests...');
                
                // Test 1: Health check
                log('Test 1: Health check');
                const healthController = new AbortController();
                const healthTimeout = setTimeout(() => healthController.abort(), 10000);
                
                try {
                    const healthResponse = await fetch('https://videodownloader-api-bfyj.onrender.com/api/health', {
                        signal: healthController.signal
                    });
                    clearTimeout(healthTimeout);
                    
                    log(`Health response status: ${healthResponse.status}`);
                    log(`Health response headers: ${Array.from(healthResponse.headers.entries()).map(([k,v]) => `${k}: ${v}`).join(', ')}`);
                    
                    const healthData = await healthResponse.json();
                    log(`Health data: ${JSON.stringify(healthData)}`);
                } catch (err) {
                    clearTimeout(healthTimeout);
                    log(`Health check failed: ${err.message}`, true);
                    return;
                }
                
                // Test 2: CORS preflight
                log('Test 2: CORS preflight check');
                const optionsController = new AbortController();
                const optionsTimeout = setTimeout(() => optionsController.abort(), 10000);
                
                try {
                    const optionsResponse = await fetch('https://videodownloader-api-bfyj.onrender.com/api/parse', {
                        method: 'OPTIONS',
                        headers: {
                            'Origin': 'http://localhost:5174'
                        },
                        signal: optionsController.signal
                    });
                    clearTimeout(optionsTimeout);
                    
                    log(`OPTIONS response status: ${optionsResponse.status}`);
                    log(`OPTIONS response headers: ${Array.from(optionsResponse.headers.entries()).map(([k,v]) => `${k}: ${v}`).join(', ')}`);
                } catch (err) {
                    clearTimeout(optionsTimeout);
                    log(`OPTIONS check failed: ${err.message}`, true);
                }
                
                // Test 3: Parse request
                log('Test 3: Parse request');
                const parseController = new AbortController();
                const parseTimeout = setTimeout(() => parseController.abort(), 15000);
                
                try {
                    const parseResponse = await fetch('https://videodownloader-api-bfyj.onrender.com/api/parse', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Origin': 'http://localhost:5174'
                        },
                        body: JSON.stringify({
                            url: 'https://www.youtube.com/watch?v=dQw4w9WgXcQ'
                        }),
                        signal: parseController.signal
                    });
                    clearTimeout(parseTimeout);
                    
                    log(`Parse response status: ${parseResponse.status}`);
                    log(`Parse response headers: ${Array.from(parseResponse.headers.entries()).map(([k,v]) => `${k}: ${v}`).join(', ')}`);
                    
                    if (parseResponse.ok) {
                        const parseData = await parseResponse.json();
                        log(`Parse successful! Found ${parseData.formats?.length || 0} video formats`);
                    } else {
                        const errorText = await parseResponse.text();
                        log(`Parse failed with status ${parseResponse.status}: ${errorText}`, true);
                    }
                } catch (err) {
                    clearTimeout(parseTimeout);
                    log(`Parse request failed: ${err.message}`, true);
                }
                
            } catch (error) {
                log(`Test suite failed: ${error.message}`, true);
                console.error('Full error:', error);
            }
        }
    </script>
</body>
</html>